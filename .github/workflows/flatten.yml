name: Flatten to single file

on:
  push:
    branches: [master]
    paths:
      - "**/*.zsh"
      - "scripts/flatten.sh"
      - ".github/workflows/flatten.yml"

concurrency:
  group: flatten
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  flatten:
    runs-on: ubuntu-latest
    env:
      GIST_PAT: ${{ secrets.GIST_PAT }}
    steps:
      - uses: actions/checkout@v6

      - name: Capture source commit
        run: |
          echo "SOURCE_SHA=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"
          echo "SOURCE_MSG=$(git log -1 --format='%s')" >> "$GITHUB_ENV"

      - name: Build flat file
        run: |
          chmod +x scripts/flatten.sh
          scripts/flatten.sh > truenas.zsh.flat

      - name: Build flat README
        run: |
          cat > README.md.flat <<EOF
          # truenas-zshrc (flat)

          Single-file build of [truenas-zshrc](https://github.com/kjanat/truenas-zshrc) — auto-generated from \`master\` by CI.

          ## Usage

          \`\`\`sh
          fetch -qo ~/.zshrc.truenas https://raw.githubusercontent.com/kjanat/truenas-zshrc/flat/truenas.zsh
          echo 'source ~/.zshrc.truenas' >> ~/.zshrc
          \`\`\`

          ## About

          This branch contains a single \`truenas.zsh\` with all \`lib/*.zsh\` modules inlined.
          Do not edit this branch directly — changes are overwritten on every push to [\`master\`](https://github.com/kjanat/truenas-zshrc/tree/master).

          Built from [\`${SOURCE_SHA}\`](https://github.com/kjanat/truenas-zshrc/commit/${SOURCE_SHA}).
          EOF

      - name: Deploy to flat branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin flat:flat 2>/dev/null || git checkout --orphan flat
          git checkout flat
          git rm -rf . 2>/dev/null || true
          mv truenas.zsh.flat truenas.zsh
          mv README.md.flat README.md
          git add truenas.zsh README.md
          if git diff --cached --quiet; then
            echo "No changes to flat branch"
            exit 0
          fi
          git commit -m "Flatten ${SOURCE_SHA}: ${SOURCE_MSG}"
          git push origin flat

      - name: Sync to gist
        if: env.GIST_PAT != ''
        uses: actions/github-script@v8
        env:
          GIST_ID: 83b9a10c9f6869607235933015c07121
        with:
          github-token: ${{ secrets.GIST_PAT }}
          script: |
            const { readFileSync } = await import('node:fs');
            const content = readFileSync('truenas.zsh', 'utf8');
            const sha = process.env.SOURCE_SHA;
            await github.rest.gists.update({
              gist_id: process.env.GIST_ID,
              description: `TrueNAS CORE ZSH config (flat build from ${sha})`,
              files: { 'truenas.zsh': { content } }
            });
            core.info(`Gist updated from ${sha}`);
